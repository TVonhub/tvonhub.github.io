<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Powershell-lv2 TV Player</title>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body { transition: background 0.3s, color 0.3s; }
  body.light { background: #ffffff; color: #111827; }
  body.light header, body.light section, body.light main > section, body.light main aside section { background-color: #ffffff !important; }
  body.dark { background: #111827; color: #f8fafc; }
  body.dark select { background-color: #ffffff; color: #000000; }
  .thin-scrollbar::-webkit-scrollbar { width:8px; }
  .thin-scrollbar::-webkit-scrollbar-thumb { background:#cbd5e1; border-radius:9999px; }
  .thin-scrollbar { scrollbar-width: thin; scrollbar-color:#cbd5e1 transparent; }
</style>
</head>
<body class="light">
<header class="sticky top-0 z-50 bg-white/20 backdrop-blur border-b border-slate-200 p-3 flex gap-3 items-center">
  <h1 class="font-semibold text-lg">M3U Live TV Player</h1>
  <button id="themeToggle" class="px-3 py-1 rounded-lg border">üåô</button>
  <button id="langToggle" class="px-3 py-1 rounded-lg border">üáπüá≠</button>
  <span id="statusBadge" class="ml-auto px-2 py-1 rounded-full bg-slate-100 text-slate-700 text-xs">‡∏û‡∏£‡πâ‡∏≠‡∏°</span>
</header>

<main class="max-w-7xl mx-auto p-4 grid grid-cols-1 md:grid-cols-[300px,1fr] gap-4">
  <aside class="space-y-4">
    <section class="p-4 rounded-2xl shadow-sm border border-slate-200">
      <label id="playlistLabel" class="block mb-2 font-medium">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà M3U</label>
      <div class="flex gap-2">
        <input id="playlistUrl" class="flex-1 px-3 py-2 rounded-xl border" />
        <button id="loadBtn" class="px-3 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700">‡πÇ‡∏´‡∏•‡∏î</button>
      </div>
      <div class="mt-3 flex gap-3 text-sm items-center">
        <label class="inline-flex items-center gap-2"><input id="autoplayToggle" type="checkbox" class="accent-indigo-600"/> ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</label>
        <button id="reloadBtn" class="ml-auto text-slate-700 border px-3 py-1.5 rounded-lg hover:bg-slate-50">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÄ‡∏û‡∏•‡∏¢‡πå‡∏•‡∏¥‡∏™‡∏ï‡πå</button>
      </div>
      <p id="errorBox" class="hidden mt-3 text-sm text-rose-700 bg-rose-50 border rounded-xl p-3"></p>
    </section>

    <section class="p-4 rounded-2xl shadow-sm border border-slate-200">
      <div class="flex gap-2 mb-2">
        <input id="searchInput" class="flex-1 px-3 py-2 rounded-xl border" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡πà‡∏≠‡∏á..." />
        <select id="groupFilter" class="px-3 py-2 rounded-xl border text-sm min-w-[140px]"></select>
      </div>
      <div id="channelCount" class="text-xs mb-2">0 ‡∏ä‡πà‡∏≠‡∏á</div>
      <ul id="channelList" class="thin-scrollbar max-h-[60vh] overflow-auto divide-y divide-slate-100"></ul>
    </section>
  </aside>

  <section class="p-3 rounded-2xl shadow-sm border flex flex-col gap-3">
    <div class="relative aspect-video bg-black rounded-xl overflow-hidden">
      <video id="video" class="w-full h-full" controls playsinline webkit-playsinline></video>
      <div id="nowPlaying" class="absolute bottom-2 left-2 right-2 text-xs md:text-sm text-white/90 bg-black/40 px-2 py-1 rounded-lg"></div>
    </div>
    <div class="flex flex-wrap gap-2 text-sm items-center">
      <span id="nowPlayingChannel" class="font-semibold"></span>
      <button id="openInNewTab" class="px-3 py-1.5 rounded-lg border hover:bg-slate-50">‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏ï‡∏£‡∏µ‡∏°</button>
      <button id="copyStreamUrl" class="px-3 py-1.5 rounded-lg border hover:bg-slate-50">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå</button>
      <span id="techInfo" class="ml-auto text-xs text-slate-500">‚Äî</span>
    </div>
  </section>
</main>

<script>
const els = {
  url: document.getElementById('playlistUrl'),
  loadBtn: document.getElementById('loadBtn'),
  reloadBtn: document.getElementById('reloadBtn'),
  autoplay: document.getElementById('autoplayToggle'),
  error: document.getElementById('errorBox'),
  list: document.getElementById('channelList'),
  search: document.getElementById('searchInput'),
  group: document.getElementById('groupFilter'),
  count: document.getElementById('channelCount'),
  video: document.getElementById('video'),
  now: document.getElementById('nowPlaying'),
  nowChannel: document.getElementById('nowPlayingChannel'),
  status: document.getElementById('statusBadge'),
  open: document.getElementById('openInNewTab'),
  copy: document.getElementById('copyStreamUrl'),
  tech: document.getElementById('techInfo'),
  theme: document.getElementById('themeToggle'),
  lang: document.getElementById('langToggle'),
  playlistLabel: document.getElementById('playlistLabel')
};

const DEFAULT_URL = 'https://powershell-lv2.github.io/tv.m3u';
let channels=[], filtered=[], groups=[], currentIndex=-1, hls=null;
let currentTheme = localStorage.getItem('theme') || 'light';
let currentLang = localStorage.getItem('lang') || 'th';
document.body.className = currentTheme;

function translateUI(){
  if(currentLang==='th'){
    els.playlistLabel.textContent='‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà M3U';
    els.search.placeholder='‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡πà‡∏≠‡∏á...';
    els.theme.textContent = document.body.classList.contains('dark')?"üåô ‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î":"‚òÄÔ∏è ‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏ß‡πà‡∏≤‡∏á";
    els.lang.textContent="üáπüá≠";
  } else {
    els.playlistLabel.textContent='M3U URL';
    els.search.placeholder='Search channel...';
    els.theme.textContent = document.body.classList.contains('dark')?"üåô Dark":"‚òÄÔ∏è Light";
    els.lang.textContent="üá¨üáß";
  }
}

function parseM3U(text){
  const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  let result=[], meta=null;
  const attrRe=/([a-zA-Z0-9\-]+)="([^"]*)"/g;
  for(const line of lines){
    if(line.startsWith('#EXTINF')){
      const attrs={}; let m;
      while((m=attrRe.exec(line))!==null) attrs[m[1]]=m[2];
      const title=line.split(',').slice(1).join(',').trim();
      meta={title, logo: attrs['tvg-logo']||'', group: attrs['group-title']||''};
    } else if(!line.startsWith('#') && meta){
      result.push({...meta, url:line});
      meta=null;
    }
  }
  return result;
}

async function loadPlaylist(url){
  try{
    const res = await fetch(url);
    const text = await res.text();
    channels=parseM3U(text);
    const groupSet = new Set(channels.map(c=>c.group||'‡∏≠‡∏∑‡πà‡∏ô‡πÜ'));
    groups=['‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', ...groupSet];
    els.group.innerHTML = groups.map(g=>`<option value="${g}">${g}</option>`).join('');
    filterChannels();
    const lastIndex = localStorage.getItem('lastChannelIndex');
    if(lastIndex !== null && filtered[lastIndex]) playIndex(lastIndex);
  }catch(e){ console.error(e); els.error.textContent=e.message; els.error.classList.remove('hidden'); }
}

function filterChannels(){
  const groupVal = els.group.value;
  const keyword = els.search.value.toLowerCase();
  filtered = channels.filter(c=>{
    const matchGroup = (groupVal==='‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' || c.group===groupVal);
    const matchKeyword = c.title.toLowerCase().includes(keyword);
    return matchGroup && matchKeyword;
  });
  renderList();
}

function renderList(){
  els.count.textContent = `${filtered.length} ‡∏ä‡πà‡∏≠‡∏á`;
  els.list.innerHTML = filtered.map((c,i)=>{
    const isActive = (i==currentIndex) ? 'bg-indigo-100 dark:bg-indigo-700' : '';
    return `
    <li class="relative group">
      <button data-i="${i}" class="flex items-center gap-2 w-full text-left px-3 py-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg ${isActive}">
        ${c.logo ? `<img src="${c.logo}" alt="" class="w-6 h-6 object-contain rounded">` : ''}
        <span>${c.title}</span>
      </button>
      <div class="absolute left-full top-1/2 transform -translate-y-1/2 ml-2 px-2 py-1 rounded-lg bg-black text-white text-xs whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity z-50 flex items-center gap-1">
        ${c.logo ? `<img src="${c.logo}" class="w-4 h-4 object-contain rounded">` : ''}
        <span>${c.title}</span>
      </div>
    </li>
    `;
  }).join('');
}

function destroyHls(){ if(hls){hls.destroy(); hls=null;} }

function playIndex(i){
  if(!filtered[i]) return;
  currentIndex=i;
  localStorage.setItem('lastChannelIndex', i);
  const url = filtered[i].url;
  const video = els.video;
  destroyHls(); video.pause(); video.removeAttribute('src'); video.load();

  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô
  els.nowChannel.textContent = filtered[i].title;

  if(Hls.isSupported()){
    hls = new Hls({
      enableWorker: true,
      lowLatencyMode: false,
      maxBufferLength: 60,
      maxMaxBufferLength: 120,
      maxBufferHole: 0.5,
      liveSyncDuration: 15,
      liveMaxLatencyDuration: 30,
      fragLoadingTimeOut: 40000,
      fragLoadingMaxRetry: 10,
      fragLoadingRetryDelay: 3000,
      manifestLoadingMaxRetry: 10
    });
    hls.on(Hls.Events.ERROR,(event,data)=>{
      if(data.fatal){
        switch(data.type){
          case Hls.ErrorTypes.NETWORK_ERROR: hls.startLoad(); break;
          case Hls.ErrorTypes.MEDIA_ERROR: hls.recoverMediaError(); break;
          default: destroyHls(); break;
        }
      }
    });
    hls.loadSource(url);
    hls.attachMedia(video);
    hls.on(Hls.Events.MANIFEST_PARSED,()=>{ video.play().catch(()=>{}); });
    els.tech.textContent='‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ: hls.js';
  } else if(video.canPlayType('application/vnd.apple.mpegurl')){
    video.src=url; video.play().catch(()=>{}); els.tech.textContent='‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ: Native HLS';
  } else {
    video.src=url; video.play().catch(()=>{}); els.tech.textContent='‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ: <video>';
  }

  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï highlight ‡∏ä‡πà‡∏≠‡∏á
  renderList();
}

// Event listeners
els.loadBtn.onclick = () => loadPlaylist(els.url.value);
els.search.addEventListener('input', filterChannels);
els.group.addEventListener('change', filterChannels);
els.list.onclick = e => { const btn = e.target.closest('button[data-i]'); if(btn) playIndex(btn.dataset.i); };
els.reloadBtn.onclick = () => loadPlaylist(els.url.value);
els.theme.onclick = () => { document.body.classList.toggle('dark'); document.body.classList.toggle('light'); localStorage.setItem('theme', document.body.className); translateUI(); };
els.lang.onclick = () => { currentLang = currentLang==='th'?'en':'th'; localStorage.setItem('lang', currentLang); translateUI(); };
els.open.onclick = () => { if(currentIndex>=0 && filtered[currentIndex]) window.open(filtered[currentIndex].url,'_blank'); };
els.copy.onclick = () => { if(currentIndex>=0 && filtered[currentIndex]){ navigator.clipboard.writeText(filtered[currentIndex].url).then(()=> alert(currentLang==='th'?'‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!':'Copied!')); } };

els.url.value = DEFAULT_URL;
loadPlaylist(DEFAULT_URL);
translateUI();
</script>
</body>
</html>
