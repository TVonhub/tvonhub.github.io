<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Powershell-lv2 Live TV</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico" />
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    :root{
      --bg:#ffffff; --fg:#111111; --muted:#666;
      --card:#ffffff; --border:#e5e5e5; --accent:#2563eb;
      --row:#f7f7f7; --row-active:#e0ecff; --buffer:#2563eb;
    }
    body.dark{
      --bg:#0f1115; --fg:#e8eef5; --muted:#a3adc2;
      --card:#131722; --border:#1e2433; --accent:#60a5fa;
      --row:#0f141f; --row-active:#1f2b43; --buffer:#60a5fa;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--fg);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans";
      line-height:1.45; transition:background .25s, color .25s;
    }
    header{
      position:sticky; top:0; z-index:10;
      display:flex; align-items:center; gap:.5rem;
      padding:.75rem 1rem; border-bottom:1px solid var(--border);
      background:color-mix(in oklab, var(--bg) 85%, #ffffff 15%);
      backdrop-filter: blur(6px);
    }
    header h1{font-size:1rem; margin:0; font-weight:600}
    header .spacer{flex:1}
    header button{
      border:1px solid var(--border); background:var(--card); color:var(--fg);
      padding:.4rem .65rem; border-radius:.65rem; cursor:pointer;
    }
    main{
      display:grid; gap:1rem; grid-template-columns: 1fr; padding:1rem; max-width:1200px; margin:0 auto;
    }
    @media (min-width: 960px){ main{ grid-template-columns: 320px 1fr; } }
    .panel{
      background:var(--card); border:1px solid var(--border); border-radius:16px; padding:1rem;
    }
    .field{ display:block; width:100%; border:1px solid var(--border); border-radius:12px; padding:.6rem .75rem; background:var(--bg); color:var(--fg); }
    .label{ font-size:.9rem; margin-bottom:.35rem; display:block; }
    .list{ margin:0; padding:0; list-style:none; max-height:65vh; overflow:auto; border:1px solid var(--border); border-radius:12px; }
    .row{
      display:flex; align-items:center; gap:.6rem;
      padding:.55rem .7rem; border-bottom:1px solid var(--border);
      background:var(--bg); cursor:pointer;
    }
    .row:nth-child(odd){ background:var(--row); }
    .row:last-child{ border-bottom:none; }
    .row:hover{ filter:brightness(1.02) }
    .row.active{ background:var(--row-active); }
    .logo{ width:26px; height:26px; object-fit:contain; border-radius:6px; background:#00000010; }
    .video-wrap{ position:relative; background:#000; border-radius:16px; overflow:hidden; }
    video{ width:100%; aspect-ratio:16/9; background:#000; display:block; }
    .status{
      margin-top:.5rem; font-size:.9rem; color:var(--muted);
      display:flex; align-items:center; gap:.75rem; flex-wrap:wrap;
    }
    .badge{ padding:.15rem .5rem; border:1px solid var(--border); border-radius:999px; }
    .buffer-rail{ position:absolute; left:0; right:0; bottom:0; height:6px; background: #e5e7eb33; }
    .buffer-bar{ height:100%; width:0%; background:var(--buffer); transition:width .2s; }
    .grid-gap{ display:grid; gap:.6rem; }

    /* ====== Donate Card Styles ====== */
    #donate-toggle{
      position:fixed; bottom:20px; right:20px;
      background:#007bff; color:white; padding:10px 15px;
      border-radius:50px; box-shadow:0 4px 8px rgba(0,0,0,0.2);
      cursor:pointer; z-index:10000; font-family:sans-serif; font-size:14px;
    }
    #donate-card{
      position:fixed; bottom:70px; right:20px;
      width:300px; padding:20px;
      border-radius:16px; box-shadow:0 4px 12px rgba(0,0,0,0.2);
      background:#ffffff; text-align:center; font-family:sans-serif; z-index:9999;
      opacity:0; transform:translateY(30px); pointer-events:none;
      transition: all 0.4s ease;
    }
    #donate-card h3, #donate-card h4{margin-bottom:10px;}
    #donate-card img{margin-bottom:10px;}

    /* ====== Modern Scrollbar (Mac-like fade) ====== */
    ::-webkit-scrollbar {
      width: 8px; height: 8px;
    }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb {
      background: var(--border); border-radius: 10px; opacity: 0;
      transition: opacity 0.4s, background 0.3s;
    }
    .show-scrollbar::-webkit-scrollbar-thumb { opacity: 1; }
    ::-webkit-scrollbar-thumb:hover { background: var(--muted); }

    /* Firefox */
    * { scrollbar-width: thin; scrollbar-color: transparent transparent; }
    .show-scrollbar { scrollbar-color: var(--border) transparent; }

  </style>
</head>
<body class="light">

  <header>
    <h1>üì∫ Powershell-lv2 Live TV</h1>
    <span class="spacer"></span>
    <button id="langBtn" title="Switch language">‡πÑ‡∏ó‡∏¢</button>
    <button id="themeBtn" title="Toggle theme">‚òÄÔ∏è</button>
  </header>

  <main>
    <aside class="panel">
      <div class="grid-gap">
        <div>
          <label class="label" id="searchLabel">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡πà‡∏≠‡∏á</label>
          <input id="searchInput" class="field" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡πà‡∏≠‡∏á..." />
        </div>
        <div>
          <label class="label" id="groupLabel">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á</label>
          <select id="groupFilter" class="field"></select>
        </div>
      </div>
      <div style="height:.75rem"></div>
      <div id="count" class="badge">0 ‡∏ä‡πà‡∏≠‡∏á</div>
      <ul id="channelList" class="list" aria-label="Channel list"></ul>
    </aside>

    <section class="panel">
      <div class="video-wrap">
        <video id="video" controls playsinline></video>
        <div class="buffer-rail"><div id="bufferBar" class="buffer-bar"></div></div>
      </div>
      <div class="status">
        <span id="nowPlaying" class="badge">‚Äî</span>
        <span id="tech" class="badge">Hls.js</span>
        <span id="bufInfo">Buffer: 0s (0%)</span>
      </div>
    </section>
  </main>

  <div id="donate-toggle">üíù Donate</div>
  <div id="donate-card">
    <div onclick="toggleDonate(false)" style="position:absolute; top:8px; right:12px; cursor:pointer; font-size:18px; color:#888;">‚úñ</div>
    
    <h3>üì¢ ‡πÅ‡∏ä‡∏£‡πå</h3>
    <div style="margin-bottom:20px;">
      <a href="https://www.facebook.com/sharer/sharer.php?u=https://powershell-lv2.github.io" target="_blank" style="text-decoration:none; margin:5px;">
        <button style="padding:8px 12px; border:none; border-radius:8px; background:#1877F2; color:white; cursor:pointer; font-size:14px;">Facebook</button>
      </a>
      <a href="https://twitter.com/intent/tweet?url=https://powershell-lv2.github.io&text=‡∏•‡∏≠‡∏á‡∏°‡∏≤‡∏î‡∏π‡∏Å‡∏±‡∏ô‡∏™‡∏¥!" target="_blank" style="text-decoration:none; margin:5px;">
        <button style="padding:8px 12px; border:none; border-radius:8px; background:#000000; color:white; cursor:pointer; font-size:14px;">X</button>
      </a>
    </div>

    <h4>‚òï Donate BTC</h4>
    <img src="https://raw.githubusercontent.com/powershell-lv2/powershell-lv2.github.io/refs/heads/main/btc.png" style="width:140px; height:140px;" alt="Donate BTC QR"/>
    <p style="font-size:12px; word-break:break-all; margin-bottom:20px;">131Kt1WfTD776XaP1qLRLPKgdn7W5aKYYH</p>

    <h4>üíô ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå</h4>
    <img src="https://raw.githubusercontent.com/powershell-lv2/powershell-lv2.github.io/refs/heads/main/Promptpay.jpg" style="width:140px; height:140px;" alt="PromptPay QR"/>
    <p style="font-size:12px; margin:0;">0947802584</p>
  </div>

  <script>
  // ====== Config ======
  const PLAYLIST_URL = "https://powershell-lv2.github.io/tv.m3u";
  const BUFFER_TARGET_SEC = 60;

  let allChannels = [];
  let viewChannels = [];
  let currentIndex = -1;
  let hls = null;
  let lang = localStorage.getItem("lang") || "th";
  let theme = localStorage.getItem("theme") || "light";

  const els = {
    video: document.getElementById("video"),
    bufferBar: document.getElementById("bufferBar"),
    bufInfo: document.getElementById("bufInfo"),
    list: document.getElementById("channelList"),
    count: document.getElementById("count"),
    search: document.getElementById("searchInput"),
    group: document.getElementById("groupFilter"),
    now: document.getElementById("nowPlaying"),
    tech: document.getElementById("tech"),
    langBtn: document.getElementById("langBtn"),
    themeBtn: document.getElementById("themeBtn"),
    searchLabel: document.getElementById("searchLabel"),
    groupLabel: document.getElementById("groupLabel"),
  };

  document.body.classList.toggle("dark", theme === "dark");
  document.body.classList.toggle("light", theme !== "dark");
  updateLangUI();

  function t(th, en){ return lang === "th" ? th : en; }

  function parseM3U(text){
    const lines = text.split(/\r?\n/);
    const out = [];
    let meta = null;
    for (let raw of lines){
      const line = raw.trim();
      if (!line) continue;
      if (line.startsWith("#EXTINF")){
        const group = /group-title="([^"]*)"/.exec(line)?.[1] ?? "";
        const logo = /tvg-logo="([^"]*)"/.exec(line)?.[1] ?? "";
        const name = line.split(",").slice(1).join(",").trim() || "Channel";
        meta = { title:name, group, logo };
      } else if (!line.startsWith("#") && meta){
        out.push({ ...meta, url: line });
        meta = null;
      }
    }
    return out;
  }

  function renderGroups(){
    const groups = Array.from(new Set(allChannels.map(c=>c.group || t("‡∏≠‡∏∑‡πà‡∏ô‡πÜ","Others"))));
    els.group.innerHTML = "";
    const optAll = document.createElement("option");
    optAll.value = "__ALL__";
    optAll.textContent = t("‡∏ó‡∏∏‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°","All groups");
    els.group.appendChild(optAll);
    groups.forEach(g=>{
      const opt = document.createElement("option");
      opt.value = g || t("‡∏≠‡∏∑‡πà‡∏ô‡πÜ","Others");
      opt.textContent = g || t("‡∏≠‡∏∑‡πà‡∏ô‡πÜ","Others");
      els.group.appendChild(opt);
    });
    els.group.value = "__ALL__";
  }

  function renderList(){
    els.list.innerHTML = "";
    viewChannels.forEach((c,i)=>{
      const li = document.createElement("li");
      li.className = "row" + (i===currentIndex ? " active" : "");
      li.title = c.title;
      li.innerHTML = (c.logo?`<img class="logo" src="${c.logo}" onerror="this.style.display='none'">`:"") + `<span>${c.title}</span>`;
      li.addEventListener("click", ()=> playIndex(i, true));
      els.list.appendChild(li);
    });
    els.count.textContent = t(`${viewChannels.length} ‡∏ä‡πà‡∏≠‡∏á`, `${viewChannels.length} channels`);
  }

  function applyFilter(){
    const q = els.search.value.trim().toLowerCase();
    const g = els.group.value;
    viewChannels = allChannels.filter(c=>{
      const okText = !q || c.title.toLowerCase().includes(q);
      const okGroup = g==="__ALL__" || (c.group || t("‡∏≠‡∏∑‡πà‡∏ô‡πÜ","Others")) === g;
      return okText && okGroup;
    });
    renderList();
  }

  function destroyHls(){
    if(hls){ try{ hls.destroy(); }catch(e){} hls=null; }
    els.video.removeAttribute("src");
    els.video.load();
  }

  function playIndex(i, userSelect=false){
    if(!viewChannels[i]) return;
    currentIndex = i;
    const ch = viewChannels[i];
    localStorage.setItem("lastUrl", ch.url);
    els.now.textContent = t("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô: ","Now playing: ") + ch.title;
    destroyHls();

    if(Hls.isSupported()){
      hls = new Hls({ maxBufferLength:60, maxBufferSize:60*1024*1024, maxBufferHole:2, liveSyncDuration:30,
                      fragLoadingMaxRetry:10, manifestLoadingMaxRetry:5, levelLoadingMaxRetry:5 });
      hls.loadSource(ch.url);
      hls.attachMedia(els.video);
      hls.on(Hls.Events.MANIFEST_PARSED, ()=> els.video.play().catch(()=>{}));
      const update = ()=> updateBufferBar();
      hls.on(Hls.Events.FRAG_BUFFERED, update);
      hls.on(Hls.Events.FRAG_LOADING, update);
      hls.on(Hls.Events.LEVEL_UPDATED, update);
      els.video.addEventListener("timeupdate", update, { passive:true });
    } else {
      els.video.src = ch.url;
      els.video.play().catch(()=>{});
      els.video.addEventListener("timeupdate", updateBufferBar, { passive:true });
    }

    renderList();
  }

  function updateBufferBar(){
    const v=els.video;
    if(v.buffered.length===0){ els.bufferBar.style.width="0%"; els.bufInfo.textContent=t("Buffer: 0‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (0%)","Buffer: 0s (0%)"); return; }
    const tNow=v.currentTime;
    let end=v.buffered.end(v.buffered.length-1);
    for(let i=0;i<v.buffered.length;i++){ if(v.buffered.start(i)<=tNow && tNow<=v.buffered.end(i)){ end=v.buffered.end(i); break; } }
    const bufferedSec=Math.max(0,end-tNow);
    const pct=Math.max(0, Math.min(100,(bufferedSec/BUFFER_TARGET_SEC)*100));
    els.bufferBar.style.width=pct+"%";
    els.bufInfo.textContent=t(`Buffer: ${bufferedSec.toFixed(1)} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (${pct.toFixed(0)}%)`, `Buffer: ${bufferedSec.toFixed(1)}s (${pct.toFixed(0)}%)`);
  }

  async function loadPlaylist(){
    try{
      const res = await fetch(PLAYLIST_URL, { cache:"no-cache" });
      const text = await res.text();
      allChannels=parseM3U(text);
      renderGroups();
      viewChannels=allChannels.slice();
      renderList();
      const lastUrl=localStorage.getItem("lastUrl");
      let idx=0;
      if(lastUrl){ const found=viewChannels.findIndex(c=>c.url===lastUrl); if(found>=0) idx=found; }
      playIndex(idx,false);
    }catch(err){
      els.now.textContent=t("‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏•‡∏¢‡πå‡∏•‡∏¥‡∏™‡∏ï‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à","Failed to load playlist");
      console.error(err);
    }
  }

  function updateLangUI(){
    els.langBtn.textContent=lang==="th"?"‡πÑ‡∏ó‡∏¢":"EN";
    els.themeBtn.textContent=document.body.classList.contains("dark")?"üåô":"‚òÄÔ∏è";
    els.search.placeholder=t("‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡πà‡∏≠‡∏á...","Search channel...");
    els.searchLabel.textContent=t("‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡πà‡∏≠‡∏á","Search");
    els.groupLabel.textContent=t("‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á","Channel group");
    els.count.textContent=t(`${viewChannels.length} ‡∏ä‡πà‡∏≠‡∏á`, `${viewChannels.length} channels`);
    const txt=els.now.textContent;
    if(txt && txt.includes(": ")){
      const name=txt.split(": ").slice(1).join(": ");
      els.now.textContent=t("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô: ","Now playing: ") + name;
    }
    updateBufferBar();
  }

  els.search.addEventListener("input",()=>{
    applyFilter();
    if(!viewChannels[currentIndex]){ if(viewChannels.length) playIndex(0,false); }else{ renderList(); }
  });

  els.group.addEventListener("change",()=>{
    applyFilter();
    if(!viewChannels[currentIndex] && viewChannels.length){ playIndex(0,false); }
  });

  els.langBtn.addEventListener("click",()=>{
    lang=(lang==="th")?"en":"th";
    localStorage.setItem("lang",lang);
    updateLangUI();
    renderList();
    renderGroups();
  });

  els.themeBtn.addEventListener("click",()=>{
    const toDark=!document.body.classList.contains("dark");
    document.body.classList.toggle("dark",toDark);
    document.body.classList.toggle("light",!toDark);
    localStorage.setItem("theme",toDark?"dark":"light");
    updateLangUI();
  });

  loadPlaylist();

  // ====== Donate Card ======
  const toggleBtn = document.getElementById('donate-toggle');
  const card = document.getElementById('donate-card');
  function toggleDonate(show=true){
    if(show){
      card.style.opacity="1";
      card.style.transform="translateY(0)";
      card.style.pointerEvents="auto";
      toggleBtn.textContent="‚ùå Close";
    }else{
      card.style.opacity="0";
      card.style.transform="translateY(30px)";
      card.style.pointerEvents="none";
      toggleBtn.textContent="üíù Donate";
    }
  }
  toggleBtn.onclick=function(){
    if(card.style.opacity==="0" || card.style.opacity===""){ toggleDonate(true); }else{ toggleDonate(false); }
  };

  // ====== Scrollbar Fade-in/out (Mac-like) ======
  let sbTimers = new WeakMap();
  function showScrollbar(el){
    el.classList.add("show-scrollbar");
    clearTimeout(sbTimers.get(el));
    const timer = setTimeout(()=> el.classList.remove("show-scrollbar"), 1000);
    sbTimers.set(el, timer);
  }
  document.addEventListener("mousemove", (e)=> { let el = e.target.closest("*"); if(el) showScrollbar(el); });
  document.addEventListener("scroll", (e)=> { let el = e.target; if(el) showScrollbar(el); }, true);

  </script>
</body>
</html>

‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏° favicon.ico ‡∏î‡πâ‡∏ß‡∏¢
