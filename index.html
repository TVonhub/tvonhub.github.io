<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>IPTV Live TV - Hls.js</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    :root{
      --bg:#ffffff; --fg:#111111; --muted:#666;
      --card:#ffffff; --border:#e5e5e5; --accent:#2563eb;
      --row:#f7f7f7; --row-active:#e0ecff; --buffer:#2563eb;
    }
    body.dark{
      --bg:#0f1115; --fg:#e8eef5; --muted:#a3adc2;
      --card:#131722; --border:#1e2433; --accent:#60a5fa;
      --row:#0f141f; --row-active:#1f2b43; --buffer:#60a5fa;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--fg);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans";
      line-height:1.45; transition:background .25s, color .25s;
    }
    header{
      position:sticky; top:0; z-index:10;
      display:flex; align-items:center; gap:.5rem;
      padding:.75rem 1rem; border-bottom:1px solid var(--border);
      background:color-mix(in oklab, var(--bg) 85%, #ffffff 15%);
      backdrop-filter: blur(6px);
    }
    header h1{font-size:1rem; margin:0; font-weight:600}
    header .spacer{flex:1}
    header button{
      border:1px solid var(--border); background:var(--card); color:var(--fg);
      padding:.4rem .65rem; border-radius:.65rem; cursor:pointer;
    }
    main{
      display:grid; gap:1rem; grid-template-columns: 1fr; padding:1rem; max-width:1200px; margin:0 auto;
    }
    @media (min-width: 960px){ main{ grid-template-columns: 320px 1fr; } }
    .panel{
      background:var(--card); border:1px solid var(--border); border-radius:16px; padding:1rem;
    }
    .field{ display:block; width:100%; border:1px solid var(--border); border-radius:12px; padding:.6rem .75rem; background:var(--bg); color:var(--fg); }
    .label{ font-size:.9rem; margin-bottom:.35rem; display:block; }
    .list{ margin:0; padding:0; list-style:none; max-height:65vh; overflow:auto; border:1px solid var(--border); border-radius:12px; }
    .row{
      display:flex; align-items:center; gap:.6rem;
      padding:.55rem .7rem; border-bottom:1px solid var(--border);
      background:var(--bg); cursor:pointer;
    }
    .row:nth-child(odd){ background:var(--row); }
    .row:last-child{ border-bottom:none; }
    .row:hover{ filter:brightness(1.02) }
    .row.active{ background:var(--row-active); }
    .logo{ width:26px; height:26px; object-fit:contain; border-radius:6px; background:#00000010; }
    .video-wrap{ position:relative; background:#000; border-radius:16px; overflow:hidden; }
    video{ width:100%; aspect-ratio:16/9; background:#000; display:block; }
    .status{
      margin-top:.5rem; font-size:.9rem; color:var(--muted);
      display:flex; align-items:center; gap:.75rem; flex-wrap:wrap;
    }
    .badge{ padding:.15rem .5rem; border:1px solid var(--border); border-radius:999px; }
    .buffer-rail{ position:absolute; left:0; right:0; bottom:0; height:6px; background: #e5e7eb33; }
    .buffer-bar{ height:100%; width:0%; background:var(--buffer); transition:width .2s; }
    .grid-gap{ display:grid; gap:.6rem; }
  </style>
</head>
<body class="light">

  <header>
    <h1>üì∫ IPTV Live</h1>
    <span class="spacer"></span>
    <button id="langBtn" title="Switch language">‡πÑ‡∏ó‡∏¢</button>
    <button id="themeBtn" title="Toggle theme">‚òÄÔ∏è</button>
  </header>

  <main>
    <!-- Sidebar: Search + Group + Channel list -->
    <aside class="panel">
      <div class="grid-gap">
        <div>
          <label class="label" id="searchLabel">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡πà‡∏≠‡∏á</label>
          <input id="searchInput" class="field" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡πà‡∏≠‡∏á..." />
        </div>
        <div>
          <label class="label" id="groupLabel">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á</label>
          <select id="groupFilter" class="field"></select>
        </div>
      </div>

      <div style="height:.75rem"></div>
      <div id="count" class="badge">0 ‡∏ä‡πà‡∏≠‡∏á</div>

      <ul id="channelList" class="list" aria-label="Channel list"></ul>
    </aside>

    <!-- Player -->
    <section class="panel">
      <div class="video-wrap">
        <video id="video" controls playsinline></video>
        <div class="buffer-rail"><div id="bufferBar" class="buffer-bar"></div></div>
      </div>
      <div class="status">
        <span id="nowPlaying" class="badge">‚Äî</span>
        <span id="tech" class="badge">Hls.js</span>
        <span id="bufInfo">Buffer: 0s (0%)</span>
      </div>
    </section>
  </main>

  <script>
  // ====== Config ======
  const PLAYLIST_URL = "https://powershell-lv2.github.io/tv.m3u"; // ‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤
  const BUFFER_TARGET_SEC = 60; // ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡πÅ‡∏ñ‡∏ö buffer

  // ====== State ======
  let allChannels = [];     // ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏û‡∏•‡∏¢‡πå‡∏•‡∏¥‡∏™‡∏ï‡πå
  let viewChannels = [];    // ‡∏ä‡πà‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏£‡∏≠‡∏á
  let currentIndex = -1;    // index ‡πÉ‡∏ô viewChannels
  let hls = null;
  let lang = localStorage.getItem("lang") || "th";  // "th" | "en"
  let theme = localStorage.getItem("theme") || "light"; // "light" | "dark"

  // ====== Elements ======
  const els = {
    video: document.getElementById("video"),
    bufferBar: document.getElementById("bufferBar"),
    bufInfo: document.getElementById("bufInfo"),
    list: document.getElementById("channelList"),
    count: document.getElementById("count"),
    search: document.getElementById("searchInput"),
    group: document.getElementById("groupFilter"),
    now: document.getElementById("nowPlaying"),
    tech: document.getElementById("tech"),
    langBtn: document.getElementById("langBtn"),
    themeBtn: document.getElementById("themeBtn"),
    searchLabel: document.getElementById("searchLabel"),
    groupLabel: document.getElementById("groupLabel"),
  };

  // ====== Init theme/lang ======
  document.body.classList.toggle("dark", theme === "dark");
  document.body.classList.toggle("light", theme !== "dark");
  updateLangUI();

  // ====== Helpers ======
  function t(th, en){ return lang === "th" ? th : en; }

  function parseM3U(text){
    const lines = text.split(/\r?\n/);
    const out = [];
    let meta = null;
    for (let raw of lines){
      const line = raw.trim();
      if (!line) continue;
      if (line.startsWith("#EXTINF")){
        const group = /group-title="([^"]*)"/.exec(line)?.[1] ?? "";
        const logo = /tvg-logo="([^"]*)"/.exec(line)?.[1] ?? "";
        const name = line.split(",").slice(1).join(",").trim() || "Channel";
        meta = { title:name, group, logo };
      } else if (!line.startsWith("#") && meta){
        out.push({ ...meta, url: line });
        meta = null;
      }
    }
    return out;
  }

  function renderGroups(){
    const groups = Array.from(new Set(allChannels.map(c=>c.group || t("‡∏≠‡∏∑‡πà‡∏ô‡πÜ","Others"))));
    els.group.innerHTML = "";
    const optAll = document.createElement("option");
    optAll.value = "__ALL__";
    optAll.textContent = t("‡∏ó‡∏∏‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°","All groups");
    els.group.appendChild(optAll);
    groups.forEach(g=>{
      const opt = document.createElement("option");
      opt.value = g || t("‡∏≠‡∏∑‡πà‡∏ô‡πÜ","Others");
      opt.textContent = g || t("‡∏≠‡∏∑‡πà‡∏ô‡πÜ","Others");
      els.group.appendChild(opt);
    });
    els.group.value = "__ALL__";
  }

  function renderList(){
    els.list.innerHTML = "";
    viewChannels.forEach((c,i)=>{
      const li = document.createElement("li");
      li.className = "row" + (i===currentIndex ? " active" : "");
      li.title = c.title;
      li.innerHTML = (c.logo?`<img class="logo" src="${c.logo}" onerror="this.style.display='none'">`:"")
                    + `<span>${c.title}</span>`;
      li.addEventListener("click", ()=> playIndex(i, true));
      els.list.appendChild(li);
    });
    els.count.textContent = t(`${viewChannels.length} ‡∏ä‡πà‡∏≠‡∏á`, `${viewChannels.length} channels`);
  }

  function applyFilter(){
    const q = els.search.value.trim().toLowerCase();
    const g = els.group.value;
    viewChannels = allChannels.filter(c=>{
      const okText = !q || c.title.toLowerCase().includes(q);
      const okGroup = g==="__ALL__" || (c.group || t("‡∏≠‡∏∑‡πà‡∏ô‡πÜ","Others")) === g;
      return okText && okGroup;
    });
    renderList();
  }

  function destroyHls(){
    if(hls){
      try{ hls.destroy(); }catch(e){}
      hls = null;
    }
    els.video.removeAttribute("src");
    els.video.load();
  }

  function playIndex(i, userSelect=false){
    if(!viewChannels[i]) return;
    currentIndex = i;
    const ch = viewChannels[i];

    // save last channel by URL (‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£‡∏Å‡∏ß‡πà‡∏≤‡∏ä‡∏∑‡πà‡∏≠)
    localStorage.setItem("lastUrl", ch.url);

    // status
    els.now.textContent = t("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô: ","Now playing: ") + ch.title;

    destroyHls();

    if (Hls.isSupported()){
      hls = new Hls({
        // Buffering
        maxBufferLength: 60,
        maxBufferSize: 60 * 1024 * 1024,
        maxBufferHole: 2,
        // Live sync
        liveSyncDuration: 30,
        // Robustness
        fragLoadingMaxRetry: 10,
        manifestLoadingMaxRetry: 5,
        levelLoadingMaxRetry: 5,
      });
      hls.loadSource(ch.url);
      hls.attachMedia(els.video);

      hls.on(Hls.Events.MANIFEST_PARSED, () => {
        // autoplay ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î/‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á
        els.video.play().catch(()=>{ /* ‡∏ö‡∏£‡∏≤‡∏ß‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ö‡∏•‡πá‡∏≠‡∏Å autoplay ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ user gesture */ });
      });

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏ñ‡∏ö buffer
      const update = ()=> updateBufferBar();
      hls.on(Hls.Events.FRAG_BUFFERED, update);
      hls.on(Hls.Events.FRAG_LOADING, update);
      hls.on(Hls.Events.LEVEL_UPDATED, update);
      els.video.addEventListener("timeupdate", update, { passive:true });

    } else if (els.video.canPlayType('application/vnd.apple.mpegurl')){
      // Safari
      els.video.src = ch.url;
      els.video.play().catch(()=>{});
      els.video.addEventListener("timeupdate", updateBufferBar, { passive:true });
    } else {
      // fallback (‡∏ö‡∏≤‡∏á‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÄ‡∏Å‡πà‡∏≤)
      els.video.src = ch.url;
      els.video.play().catch(()=>{});
      els.video.addEventListener("timeupdate", updateBufferBar, { passive:true });
    }

    // active row
    renderList();
  }

  function updateBufferBar(){
    const v = els.video;
    if (v.buffered.length === 0){
      els.bufferBar.style.width = "0%";
      els.bufInfo.textContent = t("Buffer: 0‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (0%)", "Buffer: 0s (0%)");
      return;
    }
    // ‡∏´‡∏≤‡∏ä‡πà‡∏ß‡∏á buffer ‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏° currentTime
    const tNow = v.currentTime;
    let end = v.buffered.end(v.buffered.length - 1);
    for(let i=0;i<v.buffered.length;i++){
      if (v.buffered.start(i) <= tNow && tNow <= v.buffered.end(i)){
        end = v.buffered.end(i);
        break;
      }
    }
    const bufferedSec = Math.max(0, end - tNow);
    const pct = Math.max(0, Math.min(100, (bufferedSec / BUFFER_TARGET_SEC) * 100));
    els.bufferBar.style.width = pct + "%";
    els.bufInfo.textContent = t(`Buffer: ${bufferedSec.toFixed(1)} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (${pct.toFixed(0)}%)`,
                                `Buffer: ${bufferedSec.toFixed(1)}s (${pct.toFixed(0)}%)`);
  }

  async function loadPlaylist(){
    try{
      const res = await fetch(PLAYLIST_URL, { cache: "no-cache" });
      const text = await res.text();
      allChannels = parseM3U(text);

      // groups & list
      renderGroups();

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
      viewChannels = allChannels.slice();
      renderList();

      // ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥: ‡∏ä‡πà‡∏≠‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏î‡πâ‡∏ß‡∏¢ URL) ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ, ‡πÑ‡∏°‡πà‡∏á‡∏±‡πâ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡πÅ‡∏£‡∏Å
      const lastUrl = localStorage.getItem("lastUrl");
      let idx = 0;
      if (lastUrl){
        const found = viewChannels.findIndex(c=>c.url===lastUrl);
        if (found >= 0) idx = found;
      }
      playIndex(idx, false);
    } catch(err){
      els.now.textContent = t("‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏•‡∏¢‡πå‡∏•‡∏¥‡∏™‡∏ï‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à","Failed to load playlist");
      console.error(err);
    }
  }

  function updateLangUI(){
    els.langBtn.textContent = lang === "th" ? "‡πÑ‡∏ó‡∏¢" : "EN";
    els.themeBtn.textContent = document.body.classList.contains("dark") ? "üåô" : "‚òÄÔ∏è";
    els.search.placeholder = t("‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡πà‡∏≠‡∏á...","Search channel...");
    els.searchLabel.textContent = t("‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡πà‡∏≠‡∏á","Search");
    els.groupLabel.textContent = t("‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á","Channel group");
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï count/now/bufInfo ‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏©‡∏≤ (‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ñ‡πà‡∏≤‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á)
    els.count.textContent = t(`${viewChannels.length} ‡∏ä‡πà‡∏≠‡∏á`, `${viewChannels.length} channels`);
    const txt = els.now.textContent;
    if (txt && txt.includes(": ")){
      const name = txt.split(": ").slice(1).join(": ");
      els.now.textContent = t("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô: ","Now playing: ") + name;
    }
    updateBufferBar();
  }

  // ====== Events ======
  els.search.addEventListener("input", ()=>{
    applyFilter();
    // ‡∏´‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏ñ‡∏π‡∏Å‡∏Å‡∏£‡∏≠‡∏á‡∏≠‡∏≠‡∏Å ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ä‡πà‡∏≠‡∏á‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á
    const cur = viewChannels[currentIndex];
    if (!cur){
      if (viewChannels.length) playIndex(0, false);
    } else {
      // sync active row
      renderList();
    }
  });

  els.group.addEventListener("change", ()=>{
    applyFilter();
    if (!viewChannels[currentIndex] && viewChannels.length){
      playIndex(0, false);
    }
  });

  els.langBtn.addEventListener("click", ()=>{
    lang = (lang === "th") ? "en" : "th";
    localStorage.setItem("lang", lang);
    updateLangUI();
    renderList();
    renderGroups(); // ‡∏£‡∏µ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏° "‡∏≠‡∏∑‡πà‡∏ô‡πÜ/Others" ‡πÉ‡∏ô dropdown ‡∏´‡∏≤‡∏Å‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
  });

  els.themeBtn.addEventListener("click", ()=>{
    const toDark = !document.body.classList.contains("dark");
    document.body.classList.toggle("dark", toDark);
    document.body.classList.toggle("light", !toDark);
    localStorage.setItem("theme", toDark ? "dark" : "light");
    updateLangUI();
  });

  // ====== Start ======
  loadPlaylist();
  </script>
</body>
</html>
